'; html = html.replace(/]*>/, function(m) { return m + '\n' + embed; }); const blob = new Blob([html], { type: 'text/html;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'daniel-planner-' + new Date().toISOString().slice(0, 10) + '.html'; a.click(); URL.revokeObjectURL(url); showToast('âœ… Exported as HTML app!'); } catch (e) { showToast('Export failed: ' + (e.message || 'try Export JSON instead')); } } function exportJsonBackup() { const allData = collectPlannerData(); const syncCfg = getSyncConfig(); if (syncCfg) allData[SYNC_CONFIG_KEY] = localStorage.getItem(SYNC_CONFIG_KEY); const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'daniel-planner-backup-' + new Date().toISOString().slice(0, 10) + '.json'; a.click(); URL.revokeObjectURL(url); showToast('âœ… JSON backup exported!'); } function importPlanner() { const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json,.json,.html,text/html'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(evt) { try { let data, text = evt.target.result; if (file.name.toLowerCase().endsWith('.html')) { const m = text.match(/__DANIEL_PLANNER_EMBED\s*=\s*["']([^"']+)["']/); if (!m) throw new Error('Not a valid planner HTML export'); data = JSON.parse(decodeURIComponent(escape(atob(m[1])))); } else { data = JSON.parse(text); } if (typeof data !== 'object') throw new Error('Invalid format'); let count = 0; for (const k of Object.keys(data)) { if ((k.startsWith(STORAGE_PREFIX) || k === SYNC_CONFIG_KEY) && typeof data[k] === 'string') { localStorage.setItem(k, data[k]); count++; } } showToast('âœ… Restored ' + count + ' item(s)!'); setTimeout(() => location.reload(), 1200); } catch (err) { showToast('Invalid file: ' + (err.message || 'Unknown error')); } }; reader.readAsText(file); }; input.click(); } function openCloudSyncModal() { const cfg = getSyncConfig() || {}; document.getElementById('syncIdInput').value = cfg.syncId || ''; document.getElementById('firebaseUrlInput').value = cfg.databaseURL || ''; document.getElementById('cloudSyncEnabled').checked = !!cfg.enabled; document.getElementById('cloudSyncOverlay').classList.add('open'); } function closeCloudSyncModal() { document.getElementById('cloudSyncOverlay').classList.remove('open'); } function generateSyncId() { document.getElementById('syncIdInput').value = 'planner-' + Math.random().toString(36).slice(2, 12); } function toggleCloudSync(enabled) { document.getElementById('cloudSyncEnabled').checked = enabled; } async function saveCloudSyncConfig() { const syncId = (document.getElementById('syncIdInput').value || '').trim().replace(/[^a-zA-Z0-9_-]/g, '-') || ('planner-' + Date.now()); const databaseURL = (document.getElementById('firebaseUrlInput').value || '').trim(); const enabled = document.getElementById('cloudSyncEnabled').checked; if (enabled && !databaseURL) { showToast('Enter Firebase Database URL to enable sync.'); return; } const cfg = { enabled: enabled && !!databaseURL, syncId, databaseURL: databaseURL || '' }; localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(cfg)); _firebaseDb = null; _firebaseUnsubscribe = null; if (cfg.enabled) { initFirebase(); for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith(STORAGE_PREFIX) && key !== SYNC_CONFIG_KEY) { const ref = firebaseRef(key); if (ref) try { await ref.set(localStorage.getItem(key)); } catch (e) {} } } showToast('â˜ Cloud sync enabled! Data pushed to cloud.'); } else { showToast('Cloud sync disabled.'); } closeCloudSyncModal(); document.getElementById('cloudSyncBtn').classList.toggle('btn-teal', !!cfg.enabled); document.getElementById('cloudSyncBtn').classList.toggle('btn-ghost', !cfg.enabled); } function resetPlanner() { showModal( 'Reset Planner', '
Delete ALL planner data permanently? This cannot be undone.

', 'Delete All', () => { const keys = Object.keys(localStorage).filter(k => k.startsWith(STORAGE_PREFIX)); keys.forEach(k => localStorage.removeItem(k)); showToast('Planner reset.'); setTimeout(() => location.reload(), 1000); } ); } function saveAllCurrent() { const view = document.querySelector('.view.active'); if (view && view.id === 'view-day') saveDayPlanner(); else if (view && view.id === 'view-month') saveMonthData(); else showToast('Save from Day Planner or Monthly System.'); } /* ================================================================ VIEW SWITCHING ================================================================ */ function showView(name) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.getElementById('view-' + name).classList.add('active'); document.getElementById('nav-' + name).classList.add('active'); if (name === 'calendar') renderCalendar(); if (name === 'month') renderMonthView(); if (name === 'day') renderDayView(); } /* ================================================================ CALENDAR VIEW ================================================================ */ function renderCalendar() { const label = MONTHS[calMonth] + ' ' + calYear; document.getElementById('calMonthTitle').textContent = label; document.getElementById('calHeroTitle').textContent = calYear; document.title = 'Daniel Planner â€” ' + label; buildCalGrid(); } async function buildCalGrid() { const grid = document.getElementById('calGrid'); grid.innerHTML = ''; ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => { const el = document.createElement('div'); el.className = 'cal-day-label'; el.textContent = d; grid.appendChild(el); }); const firstDay = new Date(calYear, calMonth, 1).getDay(); const daysInMonth = new Date(calYear, calMonth+1, 0).getDate(); for (let i = 0; i < firstDay; i++) { const el = document.createElement('div'); el.className = 'cal-cell empty'; grid.appendChild(el); } const keys = []; for (let d = 1; d <= daysInMonth; d++) { keys.push(dateKey(new Date(calYear, calMonth, d))); } const dataMap = {}; await Promise.all(keys.map(async k => { const d = await storageLoad('day-' + k); if (d) dataMap[k] = d; })); for (let d = 1; d <= daysInMonth; d++) { const dt = new Date(calYear, calMonth, d); const dk = dateKey(dt); const isToday = (dk === dateKey(TODAY)); const isSunday = (dt.getDay() === 0); const dayData = dataMap[dk]; const hasData = dayData && ( (dayData.mission && dayData.mission.trim()) || (dayData.tasks && dayData.tasks.some(t => t.text)) || (dayData.schedule && dayData.schedule.some(s => s.text)) ); const cell = document.createElement('div'); cell.className = 'cal-cell' + (isToday ? ' today' : '') + (isSunday ? ' sunday' : '') + (hasData ? ' has-data' : ''); const num = document.createElement('div'); num.className = 'cal-date-num'; num.textContent = d; cell.appendChild(num); if (hasData) { const preview = document.createElement('div'); preview.className = 'cal-preview'; let shown = 0; const addItem = (text, done) => { if (shown >= 3) return; const item = document.createElement('div'); item.className = 'cal-preview-item' + (done ? ' done' : ''); item.textContent = text; preview.appendChild(item); shown++; }; (dayData.tasks || []).forEach(t => t.text && addItem((t.priority ? '['+t.priority+'] ':'') + t.text, t.status === 'completed' || t.done)); (dayData.schedule || []).forEach(s => s.text && addItem('â° ' + s.text, s.done)); const total = (dayData.tasks||[]).filter(t=>t.text).length + (dayData.schedule||[]).filter(s=>s.text).length; if (total > shown) { const more = document.createElement('div'); more.className = 'cal-preview-more'; more.textContent = '+' + (total - shown) + ' moreâ€¦'; preview.appendChild(more); } cell.appendChild(preview); } cell.addEventListener('click', () => { dayViewDate = new Date(calYear, calMonth, d); showView('day'); }); grid.appendChild(cell); } } function changeCalMonth(delta) { calMonth += delta; if (calMonth > 11) { calMonth = 0; calYear++; } if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); } function changeCalYear(delta) { calYear += delta; renderCalendar(); } function goToToday() { calYear = TODAY.getFullYear(); calMonth = TODAY.getMonth(); renderCalendar(); } /* ================================================================ MONTH VIEW ================================================================ */ function renderMonthView() { const label = MONTHS[monthViewMonth] + ' ' + monthViewYear; document.getElementById('monthHeroTitle').textContent = label; document.getElementById('monthViewLabel').textContent = label; document.getElementById('mtaskMonthLabel').textContent = label; document.getElementById('midxMonthLabel').textContent = label; loadMonthData(); } function changeMonthView(delta) { monthViewMonth += delta; if (monthViewMonth > 11) { monthViewMonth = 0; monthViewYear++; } if (monthViewMonth < 0) { monthViewMonth = 11; monthViewYear--; } renderMonthView(); } async function loadMonthData() { const data = await storageLoad('month-' + monthKey(monthViewYear, monthViewMonth)); const d = data || {}; document.getElementById('ref-mission').value = d.mission || ''; document.getElementById('ref-roles').value = d.roles || ''; document.getElementById('ref-budget').value = d.budget || ''; document.getElementById('ref-contacts').value = d.contacts || ''; document.getElementById('ref-health').value = d.health || ''; document.getElementById('ref-dates').value = d.keyDates || ''; document.getElementById('ref-notes').value = d.notes || ''; buildMasterTaskList(d.tasks || []); buildMonthlyIndex(d.index || []); updateMtaskStats(); } async function saveMonthData() { const obj = { mission: document.getElementById('ref-mission').value, roles: document.getElementById('ref-roles').value, budget: document.getElementById('ref-budget').value, contacts: document.getElementById('ref-contacts').value, health: document.getElementById('ref-health').value, keyDates: document.getElementById('ref-dates').value, notes: document.getElementById('ref-notes').value, tasks: collectMasterTasks(), index: collectMonthIndex() }; const ok = await storageSave('month-' + monthKey(monthViewYear, monthViewMonth), obj); if (ok) showToast('âœ… Monthly data saved!'); updateMtaskStats(); } function buildMasterTaskList(tasks) { const container = document.getElementById('masterTaskList'); container.innerHTML = ''; const count = Math.max(20, tasks.length + 5); for (let i = 0; i < count; i++) { const t = tasks[i] || {}; const dueDisplay = t.due ? (t.due.match(/^\d{4}-\d{2}-\d{2}$/) ? formatToDdmmyyyy(t.due) : t.due) : ''; const row = document.createElement('div'); row.className = 'mtask-item'; row.innerHTML = `
${i+1}

â€”
 
${esc(t.text||'')}
${esc(dueDisplay)}
ðŸ“…
 `; container.appendChild(row); } updateMtaskStats(); } function addMasterTaskRow() { const tasks = collectMasterTasks(); tasks.push({ priority:'', text:'', due:'', done:false }); buildMasterTaskList(tasks); showToast('+ Row added'); } function collectMasterTasks() { const tasks = []; document.querySelectorAll('.mtask-item').forEach(row => { const dueEl = row.querySelector('.mtask-due'); const dueRaw = dueEl ? dueEl.value : ''; const dueIso = parseDdmmyyyy(dueRaw) || dueRaw; tasks.push({ priority: row.querySelector('select').value, text: row.querySelector('input[type="text"]:not(.mtask-due)').value, due: dueIso, done: row.querySelector('input[type="checkbox"]').checked }); }); return tasks; } function updateMtaskStats() { let total=0, done=0, a=0, b=0, c=0; document.querySelectorAll('.mtask-item').forEach(row => { const text = row.querySelector('input[type="text"]').value.trim(); if (!text) return; total++; if (row.querySelector('input[type="checkbox"]').checked) done++; const p = row.querySelector('select').value; if (p==='A') a++; else if (p==='B') b++; else if (p==='C') c++; }); document.getElementById('mtaskStats').innerHTML = `
Total
${total}
Done
${done}
Left
${total-done}
A
${a}
B
${b}
C
${c}
`; } function buildMonthlyIndex(entries) { const container = document.getElementById('monthlyIndex'); container.innerHTML = ''; const daysInMonth = new Date(monthViewYear, monthViewMonth+1, 0).getDate(); for (let d = 1; d <= daysInMonth; d++) { const e = (entries && entries[d-1]) ? entries[d-1] : {}; const row = document.createElement('div'); row.className = 'idx-item'; row.innerHTML = ` ${d} 
${esc(e.summary||'')}
 
${esc(e.category||'')}
 ðŸ“ `; container.appendChild(row); } } function openDayFromIndex(day) { dayViewDate = new Date(monthViewYear, monthViewMonth, day); showView('day'); } function collectMonthIndex() { const entries = []; document.querySelectorAll('.idx-item').forEach(row => { const inputs = row.querySelectorAll('input[type="text"]'); entries.push({ summary: inputs[0].value, category: inputs[1].value }); }); return entries; } function switchMonthTab(name, el) { document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.month-panel').forEach(p => p.classList.remove('active')); el.classList.add('active'); document.getElementById('mpanel-' + name).classList.add('active'); } function scheduleMonthSave() { clearTimeout(_monthSaveTimer); _monthSaveTimer = setTimeout(saveMonthData, 1400); } /* ================================================================ DAY PLANNER ================================================================ */ function buildDayUI() { if (_dayUIBuilt) return; _dayUIBuilt = true; const taskList = document.getElementById('dayTaskList'); taskList.innerHTML = ''; for (let i = 1; i <= 10; i++) { const row = document.createElement('div'); row.className = 'task-row'; row.id = 'dt-row-' + i; row.innerHTML = `
${i}

â€”
 
Task description...
 
â€”
 `; taskList.appendChild(row); } const sched = document.getElementById('daySchedule'); sched.innerHTML = ''; for (let h = 6; h <= 21; h++) { const lbl = h === 12 ? '12:00 PM' : h > 12 ? (h-12) + ':00 PM' : h + ':00 AM'; const row = document.createElement('div'); row.className = 'time-row'; row.innerHTML = `
${lbl}
Appointment or event...
  `; sched.appendChild(row); } } function applyPriStyle(i) { const sel = document.getElementById('dt-pri-' + i); if (!sel) return; const v = sel.value; sel.style.color = v==='A' ? '#C62828' : v==='B' ? '#E65100' : v==='C' ? '#1565C0' : ''; sel.style.borderColor = v==='A' ? '#C62828' : v==='B' ? '#E65100' : v==='C' ? '#1565C0' : ''; } function toggleStatusRow(i) { const row = document.getElementById('dt-row-' + i); const sel = document.getElementById('dt-status-' + i); if (!row || !sel) return; row.classList.toggle('done-row', sel.value === 'completed'); } function renderDayView() { buildDayUI(); const dk = dateKey(dayViewDate); const dayNum = dayViewDate.getDate(); const dayName = DAYS[dayViewDate.getDay()]; const monthNm = MONTHS[dayViewDate.getMonth()]; const fullDate = dayName + ', ' + monthNm + ' ' + dayNum + ', ' + dayViewDate.getFullYear(); document.getElementById('dayHeroTitle').textContent = fullDate; document.getElementById('dayViewTitle').textContent = fullDate; document.getElementById('dayBigNum').textContent = dayNum; document.getElementById('dayDateInput').value = dk; document.getElementById('dayDayName').value = dayName; _dayLoading = true; clearTimeout(_daySaveTimer); clearDayFields(); loadDayData(dk).then(() => { _dayLoading = false; }); } function clearDayFields() { document.getElementById('dayMission').value = ''; document.getElementById('dayNotes').value = ''; for (let i = 1; i <= 10; i++) { const pri = document.getElementById('dt-pri-' + i); if (pri) { pri.value=''; pri.style.color=''; pri.style.borderColor=''; } const txt = document.getElementById('dt-txt-' + i); if (txt) txt.value = ''; const status = document.getElementById('dt-status-' + i); if (status) status.value = ''; const row = document.getElementById('dt-row-' + i); if (row) row.classList.remove('done-row'); } for (let h = 6; h <= 21; h++) { const txt = document.getElementById('ds-txt-' + h); if (txt) txt.value = ''; const chk = document.getElementById('ds-chk-' + h); if (chk) chk.checked = false; } } async function loadDayData(dk) { const data = await storageLoad('day-' + dk); if (!data) return; document.getElementById('dayMission').value = data.mission || ''; document.getElementById('dayNotes').value = data.notes || ''; if (data.tasks) { data.tasks.forEach((t, idx) => { const i = idx + 1; const pri = document.getElementById('dt-pri-' + i); if (pri) { pri.value = t.priority || ''; applyPriStyle(i); } const txt = document.getElementById('dt-txt-' + i); if (txt) txt.value = t.text || ''; const status = document.getElementById('dt-status-' + i); if (status) { status.value = t.status || (t.done ? 'completed' : ''); toggleStatusRow(i); } }); } if (data.schedule) { data.schedule.forEach((s, idx) => { const h = 6 + idx; const txt = document.getElementById('ds-txt-' + h); if (txt) txt.value = s.text || ''; const chk = document.getElementById('ds-chk-' + h); if (chk) chk.checked = !!s.done; }); } } async function saveDayPlanner() { const dk = dateKey(dayViewDate); const tasks = []; for (let i = 1; i <= 10; i++) { const status = (document.getElementById('dt-status-' + i) || {}).value || ''; tasks.push({ priority: (document.getElementById('dt-pri-' + i) || {}).value || '', text: (document.getElementById('dt-txt-' + i) || {}).value || '', status, done: status === 'completed' }); } const schedule = []; for (let h = 6; h <= 21; h++) { schedule.push({ hour: h, text: (document.getElementById('ds-txt-' + h) || {}).value || '', done: !!(document.getElementById('ds-chk-' + h) || {}).checked }); } const obj = { date: dk, mission: document.getElementById('dayMission').value, notes: document.getElementById('dayNotes').value, tasks, schedule, savedAt: new Date().toISOString() }; const ok = await storageSave('day-' + dk, obj); if (ok) { showToast('âœ… Saved â€” ' + dk); syncIndexFromDay(dayViewDate, obj); } } function scheduleDaySave() { if (_dayLoading) return; _pendingSave = true; clearTimeout(_daySaveTimer); _daySaveTimer = setTimeout(saveDayPlanner, 1500); } async function loadDayPlanner() { _dayLoading = true; clearTimeout(_daySaveTimer); clearDayFields(); await loadDayData(dateKey(dayViewDate)); _dayLoading = false; showToast('ðŸ“‚ Day planner loaded!'); } function clearDayPlanner() { showModal( 'Clear Day Planner', '
Clear all fields? Saved data is not deleted.

', 'Clear', () => { clearDayFields(); showToast('ðŸ—‘ï¸ Fields cleared'); } ); } function changeDayView(delta) { const d = new Date(dayViewDate); d.setDate(d.getDate() + delta); dayViewDate = d; renderDayView(); } function goToDayToday() { dayViewDate = new Date(TODAY); renderDayView(); } document.getElementById('dayDateInput').addEventListener('change', function() { dayViewDate = new Date(this.value + 'T00:00:00'); renderDayView(); }); async function syncIndexFromDay(dt, dayData) { const mk = monthKey(dt.getFullYear(), dt.getMonth()); const prev = await storageLoad('month-' + mk) || {}; const days = new Date(dt.getFullYear(), dt.getMonth()+1, 0).getDate(); const index = Array.from({ length: days }, (_, i) => { return (prev.index && prev.index[i]) ? Object.assign({}, prev.index[i]) : {}; }); const d = dt.getDate() - 1; let summary = ''; if (dayData.mission && dayData.mission.trim()) { summary = dayData.mission.substring(0, 60); } else { const ft = (dayData.tasks || []).find(t => t.text); if (ft) summary = (ft.priority ? '['+ft.priority+'] ' : '') + ft.text.substring(0, 50); } if (summary) { index[d].summary = summary; prev.index = index; if (!prev.tasks) prev.tasks = []; await storageSave('month-' + mk, prev); } } /* ================================================================ UTILITIES ================================================================ */ function esc(s) { return (s || '').replace(/&/g,'&').replace(//g,'>').replace(/"/g,'"'); } window.addEventListener('beforeunload', function(e) { if (_pendingSave) { e.preventDefault(); e.returnValue = 'You have unsaved changes.'; } }); /* ================================================================ INIT ================================================================ */ window.addEventListener('DOMContentLoaded', () => { buildDayUI(); renderCalendar(); const cfg = getSyncConfig(); if (cfg && cfg.enabled) { document.getElementById('cloudSyncBtn').classList.add('btn-teal'); document.getElementById('cloudSyncBtn').classList.remove('btn-ghost'); initFirebase(); } });
