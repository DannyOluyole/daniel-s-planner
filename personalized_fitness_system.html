<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Personalized Fitness System</title>
    <meta name="description" content="Personalized Fitness System (single-file build): profile intake, plan generator, workout + bodyweight logging, and progress charts." />
    <style>
/* Personalized Fitness System — minimal modern styles */
*, *::before, *::after { box-sizing: border-box; }

:root{
  --bg: #0b1220;
  --panel: rgba(255,255,255,0.06);
  --panel-2: rgba(255,255,255,0.10);
  --border: rgba(255,255,255,0.14);
  --text: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.72);
  --faint: rgba(255,255,255,0.55);
  --accent: #39d98a;
  --accent-2: #58a6ff;
  --warn: #ffb020;
  --danger: #ff4d4f;
  --shadow: 0 18px 60px rgba(0,0,0,0.45);
  --radius: 14px;
}

html, body { height: 100%; }
body{
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  color: var(--text);
  background:
    radial-gradient(1200px 800px at 15% 10%, rgba(88,166,255,0.24), transparent 60%),
    radial-gradient(1000px 700px at 85% 15%, rgba(57,217,138,0.18), transparent 55%),
    radial-gradient(900px 700px at 50% 110%, rgba(255,176,32,0.10), transparent 60%),
    var(--bg);
}

a { color: inherit; }
button, input, select, textarea { font: inherit; color: inherit; }

.app{
  max-width: 1200px;
  margin: 0 auto;
  padding: 22px 18px 50px;
}

.topbar{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 16px 18px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: rgba(0,0,0,0.20);
  box-shadow: var(--shadow);
  position: sticky;
  top: 12px;
  z-index: 50;
  backdrop-filter: blur(10px);
}

.brand{
  display:flex; flex-direction:column; gap: 2px;
}
.brand .title{
  font-weight: 800;
  letter-spacing: -0.02em;
  font-size: 1.05rem;
}
.brand .subtitle{
  font-size: 0.82rem;
  color: var(--muted);
}

.nav{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
}
.tab{
  border: 1px solid transparent;
  background: transparent;
  color: var(--muted);
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
  transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
  user-select: none;
}
.tab:hover { transform: translateY(-1px); background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.10); color: var(--text); }
.tab.active { background: rgba(57,217,138,0.10); border-color: rgba(57,217,138,0.35); color: var(--text); }

.actions{
  display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;
}

.btn{
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.06);
  cursor: pointer;
  transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
}
.btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.18); }
.btn.primary{ background: rgba(57,217,138,0.12); border-color: rgba(57,217,138,0.38); }
.btn.danger{ background: rgba(255,77,79,0.12); border-color: rgba(255,77,79,0.38); }
.btn.small{ padding: 8px 10px; border-radius: 10px; font-size: 0.92rem; }

.hero{
  margin-top: 18px;
  padding: 18px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.12));
}
.hero h1{
  margin: 0 0 8px;
  font-size: 1.6rem;
  letter-spacing: -0.02em;
}
.hero p{
  margin: 0;
  color: var(--muted);
  line-height: 1.5;
}
.pillrow{
  margin-top: 12px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.pill{
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.05);
  color: var(--muted);
  font-size: 0.9rem;
}
.pill strong{ color: var(--text); font-weight: 800; }

.grid{
  margin-top: 18px;
  display:grid;
  grid-template-columns: 1fr;
  gap: 14px;
}
@media (min-width: 980px){
  .grid.two{ grid-template-columns: 1fr 1fr; }
  .grid.three{ grid-template-columns: 1.05fr 1fr 1fr; }
}

.card{
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.04);
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
  overflow: hidden;
}
.card .head{
  padding: 14px 16px;
  display:flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  background: rgba(0,0,0,0.20);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.card .head .h{
  font-weight: 800;
  letter-spacing: -0.01em;
}
.card .body{ padding: 16px; }

.view{ display: none; }
.view.active{ display:block; }

.form{
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
@media (min-width: 720px){
  .form.two{ grid-template-columns: 1fr 1fr; }
  .form.three{ grid-template-columns: 1fr 1fr 1fr; }
}
.field label{
  display:block;
  font-size: 0.88rem;
  color: var(--muted);
  margin-bottom: 6px;
}
.field input, .field select, .field textarea{
  width: 100%;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.20);
  padding: 10px 12px;
  outline: none;
}
.field input:focus, .field select:focus, .field textarea:focus{
  border-color: rgba(88,166,255,0.55);
  box-shadow: 0 0 0 4px rgba(88,166,255,0.14);
}
.field textarea{ min-height: 92px; resize: vertical; line-height: 1.45; }
.hint{ margin-top: 8px; color: var(--faint); font-size: 0.88rem; line-height: 1.45; }

.kpi{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
@media (min-width: 720px){ .kpi{ grid-template-columns: 1fr 1fr; } }
.k{
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.04);
}
.k .l{ color: var(--muted); font-size: 0.85rem; }
.k .v{ font-weight: 900; letter-spacing: -0.02em; margin-top: 4px; font-size: 1.02rem; }
.k .s{ color: var(--faint); font-size: 0.85rem; margin-top: 4px; line-height: 1.35; }

.list{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.item{
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  background: rgba(255,255,255,0.04);
  padding: 12px;
  display:flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
}
.item .meta{
  display:flex;
  flex-direction: column;
  gap: 4px;
}
.item .meta .t{ font-weight: 800; }
.item .meta .d{ color: var(--muted); font-size: 0.88rem; }
.item .meta .n{ color: var(--faint); font-size: 0.88rem; white-space: pre-wrap; }
.item .right{ display:flex; gap: 8px; align-items: center; }

.canvaswrap{
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  padding: 12px;
}
canvas{ width: 100%; height: 220px; display:block; }

.toast{
  position: fixed;
  bottom: 16px;
  right: 16px;
  background: rgba(0,0,0,0.70);
  border: 1px solid rgba(255,255,255,0.16);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  opacity: 0;
  transform: translateY(12px);
  transition: opacity 160ms ease, transform 160ms ease;
  z-index: 100;
  max-width: 520px;
}
.toast.show{ opacity: 1; transform: translateY(0); }

.modalOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.58);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 200;
}
.modalOverlay.open{ display:flex; }
.modal{
  width: 100%;
  max-width: 760px;
  border-radius: 16px;
  background: rgba(11,18,32,0.95);
  border: 1px solid rgba(255,255,255,0.16);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.modal .mhead{
  padding: 14px 16px;
  font-weight: 900;
  background: rgba(0,0,0,0.25);
  border-bottom: 1px solid rgba(255,255,255,0.10);
}
.modal .mbody{ padding: 16px; }
.modal .mfoot{
  padding: 12px 16px;
  border-top: 1px solid rgba(255,255,255,0.10);
  display:flex;
  justify-content: flex-end;
  gap: 10px;
}

.warn{
  color: rgba(255,176,32,0.95);
  font-weight: 800;
}
.dangerText{ color: rgba(255,77,79,0.95); font-weight: 800; }

.footer{
  margin-top: 26px;
  color: var(--faint);
  font-size: 0.86rem;
  line-height: 1.45;
}
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <div class="title">Personalized Fitness System</div>
          <div class="subtitle">Profile → Plan → Log → Progress (stored locally)</div>
        </div>
        <nav class="nav" aria-label="Primary">
          <button class="tab" id="tab-profile" type="button">Profile</button>
          <button class="tab" id="tab-plan" type="button">Plan</button>
          <button class="tab" id="tab-log" type="button">Log</button>
          <button class="tab" id="tab-progress" type="button">Progress</button>
          <button class="tab" id="tab-settings" type="button">Settings</button>
        </nav>
      </header>

      <section class="hero" aria-live="polite">
        <h1 id="heroTitle">Your Personalized Fitness System</h1>
        <p>
          A practical, rules-based coach to generate a weekly plan from your profile, then track workouts and progress over time.
          Data stays in your browser unless you export it.
        </p>
        <div class="pillrow">
          <div class="pill" id="pillPlan"><strong>Plan</strong> —</div>
          <div class="pill" id="pillUpdated"><strong>Updated</strong> —</div>
          <div class="pill" id="pillDays"><strong>—</strong> days/week</div>
          <div class="pill" id="pillGoal"><strong>Goal</strong> —</div>
        </div>
      </section>

      <section class="view" id="view-profile">
        <div class="grid two">
          <div class="card">
            <div class="head">
              <div class="h">Your profile</div>
              <div class="actions">
                <button class="btn small" type="button" id="btnSaveProfile">Save profile</button>
                <button class="btn small primary" type="button" id="btnGenerate">Generate plan</button>
              </div>
            </div>
            <div class="body">
              <div class="form two">
                <div class="field">
                  <label for="p_name">Name (optional)</label>
                  <input id="p_name" type="text" placeholder="e.g. Alex" autocomplete="name" />
                </div>
                <div class="field">
                  <label for="p_sex">Sex (for BMR estimate)</label>
                  <select id="p_sex">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
              </div>

              <div class="form three" style="margin-top:12px;">
                <div class="field">
                  <label for="p_age">Age</label>
                  <input id="p_age" type="number" inputmode="numeric" min="10" max="120" placeholder="e.g. 32" />
                </div>
                <div class="field">
                  <label for="p_height">Height (cm)</label>
                  <input id="p_height" type="number" inputmode="decimal" min="120" max="230" placeholder="e.g. 178" />
                </div>
                <div class="field">
                  <label for="p_weight">Weight (kg)</label>
                  <input id="p_weight" type="number" inputmode="decimal" min="35" max="250" placeholder="e.g. 82" />
                </div>
              </div>

              <div class="form three" style="margin-top:12px;">
                <div class="field">
                  <label for="p_goal">Primary goal</label>
                  <select id="p_goal">
                    <option value="general">General health</option>
                    <option value="fat_loss">Fat loss</option>
                    <option value="muscle_gain">Muscle gain</option>
                    <option value="endurance">Endurance</option>
                  </select>
                </div>
                <div class="field">
                  <label for="p_exp">Experience</label>
                  <select id="p_exp">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                  </select>
                </div>
                <div class="field">
                  <label for="p_activity">Baseline activity</label>
                  <select id="p_activity">
                    <option value="sedentary">Sedentary</option>
                    <option value="light">Light</option>
                    <option value="moderate">Moderate</option>
                    <option value="high">High</option>
                  </select>
                </div>
              </div>

              <div class="form three" style="margin-top:12px;">
                <div class="field">
                  <label for="p_days">Days/week</label>
                  <select id="p_days">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                  </select>
                </div>
                <div class="field">
                  <label for="p_minutes">Session length (minutes)</label>
                  <select id="p_minutes">
                    <option value="30">30</option>
                    <option value="45">45</option>
                    <option value="60">60</option>
                    <option value="75">75</option>
                    <option value="90">90</option>
                  </select>
                </div>
                <div class="field">
                  <label for="p_eq">Equipment</label>
                  <select id="p_eq">
                    <option value="none">None (bodyweight)</option>
                    <option value="dumbbells">Dumbbells</option>
                    <option value="full_gym">Full gym</option>
                  </select>
                </div>
              </div>

              <div class="form two" style="margin-top:12px;">
                <div class="field">
                  <label for="p_injuries">Injuries / constraints (optional)</label>
                  <textarea id="p_injuries" placeholder="e.g. lower-back sensitive, avoid heavy hinging"></textarea>
                </div>
                <div class="field">
                  <label for="p_prefs">Preferences (optional)</label>
                  <textarea id="p_prefs" placeholder="e.g. prefer full-body workouts, extra focus on glutes + posture"></textarea>
                </div>
              </div>

              <div class="hint">
                Plan quality improves with age/height/weight. If you’re unsure, leave blanks and focus on training consistency first.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head">
              <div class="h">Quick estimates</div>
            </div>
            <div class="body">
              <div class="kpi" id="profileSummary"></div>
              <div class="hint" style="margin-top:10px;">
                These are estimates, not medical advice. If you have a condition, pain, or are pregnant, consult a professional.
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-plan">
        <div class="grid two">
          <div class="card">
            <div class="head">
              <div class="h">Your plan</div>
              <div class="actions">
                <button class="btn small" type="button" id="btnGenerate2">Regenerate</button>
              </div>
            </div>
            <div class="body" id="planWrap"></div>
          </div>

          <div class="card">
            <div class="head">
              <div class="h">How to use it</div>
            </div>
            <div class="body">
              <div class="list">
                <div class="item">
                  <div class="meta">
                    <div class="t">Train consistently</div>
                    <div class="d">Hit your weekly days. If you miss a day, resume—don’t “make up” with double sessions.</div>
                  </div>
                </div>
                <div class="item">
                  <div class="meta">
                    <div class="t">Progress slowly</div>
                    <div class="d">Add a little weight or reps only when sets feel solid with ~2–3 reps in reserve.</div>
                  </div>
                </div>
                <div class="item">
                  <div class="meta">
                    <div class="t">Track the basics</div>
                    <div class="d">Log workouts and bodyweight weekly. Small trends matter more than single-day spikes.</div>
                  </div>
                </div>
                <div class="item">
                  <div class="meta">
                    <div class="t">Adjust with data</div>
                    <div class="d">If weight is flat for 2–3 weeks, change calories by ~150–250/day or add steps.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-log">
        <div class="grid two">
          <div class="card">
            <div class="head">
              <div class="h">Log workout</div>
            </div>
            <div class="body">
              <div class="form two">
                <div class="field">
                  <label for="w_date">Date</label>
                  <input id="w_date" type="date" />
                </div>
                <div class="field">
                  <label for="w_type">Type</label>
                  <select id="w_type">
                    <option value="strength">Strength</option>
                    <option value="cardio">Cardio</option>
                    <option value="mobility">Mobility</option>
                  </select>
                </div>
              </div>
              <div class="form two" style="margin-top:12px;">
                <div class="field">
                  <label for="w_title">Title (optional)</label>
                  <input id="w_title" type="text" placeholder="e.g. Full Body A" />
                </div>
                <div class="field">
                  <label for="w_minutes">Duration (minutes)</label>
                  <input id="w_minutes" type="number" inputmode="numeric" min="5" max="300" placeholder="e.g. 45" />
                </div>
              </div>
              <div class="form two" style="margin-top:12px;">
                <div class="field">
                  <label for="w_rpe">RPE (optional)</label>
                  <input id="w_rpe" type="number" inputmode="numeric" min="1" max="10" placeholder="1–10" />
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button class="btn primary" type="button" id="btnAddWorkout">Add workout</button>
                </div>
              </div>
              <div class="field" style="margin-top:12px;">
                <label for="w_notes">Notes (optional)</label>
                <textarea id="w_notes" placeholder="e.g. felt strong, increased squat by +2.5kg"></textarea>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head">
              <div class="h">Log body metrics</div>
            </div>
            <div class="body">
              <div class="form two">
                <div class="field">
                  <label for="b_date">Date</label>
                  <input id="b_date" type="date" />
                </div>
                <div class="field">
                  <label for="b_weight">Weight (kg)</label>
                  <input id="b_weight" type="number" inputmode="decimal" min="30" max="250" placeholder="e.g. 82.4" />
                </div>
              </div>
              <div class="form two" style="margin-top:12px;">
                <div class="field">
                  <label for="b_waist">Waist (cm) (optional)</label>
                  <input id="b_waist" type="number" inputmode="decimal" min="40" max="180" placeholder="e.g. 86" />
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button class="btn primary" type="button" id="btnAddBody">Add entry</button>
                </div>
              </div>
              <div class="field" style="margin-top:12px;">
                <label for="b_notes">Notes (optional)</label>
                <textarea id="b_notes" placeholder="e.g. morning weigh-in, after rest day"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="grid two">
          <div class="card">
            <div class="head">
              <div class="h">Recent workouts</div>
            </div>
            <div class="body" id="workoutList"></div>
          </div>
          <div class="card">
            <div class="head">
              <div class="h">Recent body entries</div>
            </div>
            <div class="body" id="bodyList"></div>
          </div>
        </div>
      </section>

      <section class="view" id="view-progress">
        <div class="grid two">
          <div class="card">
            <div class="head">
              <div class="h">Weight trend</div>
            </div>
            <div class="body">
              <div class="canvaswrap">
                <canvas id="weightChart"></canvas>
              </div>
              <div class="hint">Tip: log weight 3–7x/week, then focus on weekly averages.</div>
            </div>
          </div>
          <div class="card">
            <div class="head">
              <div class="h">Workout consistency</div>
            </div>
            <div class="body">
              <div class="canvaswrap">
                <canvas id="workoutChart"></canvas>
              </div>
              <div class="hint">Consistency is the #1 predictor of results. Aim for your planned weekly frequency.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-settings">
        <div class="grid two">
          <div class="card">
            <div class="head">
              <div class="h">Backup & data</div>
            </div>
            <div class="body">
              <div class="actions">
                <button class="btn" type="button" id="btnExport">Export backup</button>
                <button class="btn" type="button" id="btnImport">Import backup</button>
                <button class="btn danger" type="button" id="btnReset">Reset everything</button>
              </div>
              <div class="hint" style="margin-top:10px;">
                Export creates a JSON file with your profile, plan, and logs. Import replaces current data with the file content.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head">
              <div class="h">About this MVP</div>
            </div>
            <div class="body">
              <div class="hint">
                This is a rules-based generator (not AI coaching). It’s designed to be safe-by-default and easy to extend.
                Next steps could include exercise libraries, progression tracking per lift, and meal planning templates.
              </div>
              <div class="footer">
                <div><strong>Privacy:</strong> stored in your browser <code>localStorage</code>.</div>
                <div><strong>Disclaimer:</strong> educational only; not medical advice.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="toast" id="toast" role="status" aria-live="polite"></div>

      <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal">
          <div class="mhead" id="modalTitle">Confirm</div>
          <div class="mbody" id="modalBody"></div>
          <div class="mfoot">
            <button class="btn" type="button" id="modalCancel">Cancel</button>
            <button class="btn danger" type="button" id="modalConfirm">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <script>
/* engine.js (inlined) */
(function (root, factory) {
  if (typeof module === "object" && typeof module.exports === "object") {
    module.exports = factory();
  } else {
    root.PFSEngine = factory();
  }
})(typeof self !== "undefined" ? self : this, function () {
  "use strict";

  const clamp = (n, lo, hi) => Math.min(hi, Math.max(lo, n));
  const round = (n, digits = 0) => {
    const p = Math.pow(10, digits);
    return Math.round(n * p) / p;
  };

  function normalizeProfile(profile) {
    const p = profile || {};
    return {
      name: (p.name || "").trim(),
      sex: p.sex === "female" ? "female" : "male",
      age: Number.isFinite(+p.age) ? clamp(+p.age, 10, 120) : null,
      heightCm: Number.isFinite(+p.heightCm) ? clamp(+p.heightCm, 120, 230) : null,
      weightKg: Number.isFinite(+p.weightKg) ? clamp(+p.weightKg, 35, 250) : null,
      goal: ["fat_loss", "muscle_gain", "endurance", "general"].includes(p.goal) ? p.goal : "general",
      experience: ["beginner", "intermediate", "advanced"].includes(p.experience) ? p.experience : "beginner",
      daysPerWeek: Number.isFinite(+p.daysPerWeek) ? clamp(Math.round(+p.daysPerWeek), 2, 6) : 3,
      sessionMinutes: Number.isFinite(+p.sessionMinutes) ? clamp(Math.round(+p.sessionMinutes), 20, 120) : 45,
      equipment: ["none", "dumbbells", "full_gym"].includes(p.equipment) ? p.equipment : "none",
      activityLevel: ["sedentary", "light", "moderate", "high"].includes(p.activityLevel) ? p.activityLevel : "light",
      injuries: (p.injuries || "").trim(),
      preferences: (p.preferences || "").trim(),
    };
  }

  function mifflinStJeorBmr({ sex, weightKg, heightCm, age }) {
    if (!weightKg || !heightCm || !age) return null;
    const base = 10 * weightKg + 6.25 * heightCm - 5 * age;
    return sex === "female" ? base - 161 : base + 5;
  }

  function activityFactor(level) {
    switch (level) {
      case "sedentary":
        return 1.2;
      case "light":
        return 1.375;
      case "moderate":
        return 1.55;
      case "high":
        return 1.725;
      default:
        return 1.375;
    }
  }

  function estimateTdee(profile) {
    const p = normalizeProfile(profile);
    const bmr = mifflinStJeorBmr(p);
    if (!bmr) return null;
    const tdee = bmr * activityFactor(p.activityLevel);
    return { bmr: round(bmr), tdee: round(tdee) };
  }

  function calorieTarget(goal, tdee) {
    if (!tdee) return null;
    switch (goal) {
      case "fat_loss":
        return round(tdee * 0.85);
      case "muscle_gain":
        return round(tdee * 1.08);
      case "endurance":
        return round(tdee * 1.05);
      case "general":
      default:
        return round(tdee);
    }
  }

  function macroTargets(profile) {
    const p = normalizeProfile(profile);
    const est = estimateTdee(p);
    if (!est || !p.weightKg) return null;

    const calories = calorieTarget(p.goal, est.tdee);
    const proteinPerKg =
      p.goal === "fat_loss" ? 1.8 :
      p.goal === "muscle_gain" ? 1.6 :
      p.goal === "endurance" ? 1.4 : 1.6;
    const fatPerKg = p.goal === "endurance" ? 0.7 : 0.8;

    const proteinG = round(p.weightKg * proteinPerKg);
    const fatG = round(p.weightKg * fatPerKg);
    const proteinCals = proteinG * 4;
    const fatCals = fatG * 9;
    const carbCals = Math.max(0, calories - proteinCals - fatCals);
    const carbsG = round(carbCals / 4);

    const calsFromMacros = proteinCals + fatCals + carbsG * 4;

    return {
      calories,
      proteinG,
      carbsG,
      fatG,
      bmr: est.bmr,
      tdee: est.tdee,
      note: calsFromMacros !== calories ? "Macros rounded; calories approximate." : "",
    };
  }

  function dayNames() {
    return ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
  }

  function chooseSplit(profile) {
    const p = normalizeProfile(profile);
    const d = p.daysPerWeek;
    if (d <= 3) return "full_body";
    if (d === 4) return "upper_lower";
    if (d === 5) return "upper_lower_plus";
    return "ppl";
  }

  function templateExercises(equipment) {
    if (equipment === "full_gym") {
      return {
        squat: ["Back Squat", "Leg Press", "Goblet Squat"],
        hinge: ["Romanian Deadlift", "Deadlift (light)", "Hip Thrust"],
        push: ["Bench Press", "Incline DB Press", "Push-ups"],
        pull: ["Lat Pulldown", "Barbell Row", "Cable Row"],
        shoulders: ["Overhead Press", "DB Shoulder Press", "Lateral Raise"],
        core: ["Dead Bug", "Plank", "Cable Chop"],
        cardio: ["Incline Walk", "Bike", "Row Erg"],
      };
    }
    if (equipment === "dumbbells") {
      return {
        squat: ["Goblet Squat", "Split Squat", "DB Front Squat"],
        hinge: ["DB Romanian Deadlift", "Hip Hinge Good Morning", "Glute Bridge"],
        push: ["DB Floor Press", "Push-ups", "DB Incline Press (bench)"],
        pull: ["1-Arm DB Row", "Chest-Supported DB Row", "Band Row (if available)"],
        shoulders: ["DB Shoulder Press", "Lateral Raise", "Rear Delt Fly"],
        core: ["Plank", "Side Plank", "Hollow Hold"],
        cardio: ["Brisk Walk", "Jog", "Bike (if available)"],
      };
    }
    return {
      squat: ["Air Squat", "Split Squat", "Step-ups"],
      hinge: ["Hip Hinge", "Single-Leg RDL (bodyweight)", "Glute Bridge"],
      push: ["Push-ups", "Pike Push-ups", "Incline Push-ups"],
      pull: ["Doorway Row (towel)", "Isometric Row (towel)", "Prone Swimmer"],
      shoulders: ["Pike Push-ups", "Y-T-W Raises", "Scapular Push-ups"],
      core: ["Plank", "Dead Bug", "Hollow Hold"],
      cardio: ["Brisk Walk", "Intervals (walk/jog)", "Stairs"],
    };
  }

  function repScheme(experience, goal) {
    if (goal === "endurance") return { sets: "2–3", reps: "12–20", rest: "45–75s" };
    if (goal === "fat_loss") return { sets: "2–4", reps: "8–15", rest: "60–90s" };
    if (experience === "advanced") return { sets: "3–5", reps: "5–10", rest: "90–150s" };
    if (experience === "intermediate") return { sets: "3–4", reps: "6–12", rest: "75–120s" };
    return { sets: "2–3", reps: "8–12", rest: "60–90s" };
  }

  function cardioPrescription(goal, sessionMinutes) {
    if (goal === "muscle_gain") {
      return sessionMinutes >= 60
        ? "Optional: 1–2x/week Zone 2 (20–30 min) for recovery."
        : "Optional: light walks on rest days.";
    }
    if (goal === "endurance") return "2–4x/week: Zone 2 (30–45 min) + 1 interval day.";
    if (goal === "fat_loss") return "2–3x/week: Zone 2 (25–40 min) + 8–12k steps/day target.";
    return "2x/week: Zone 2 (20–30 min) + daily walks.";
  }

  function buildWeeklyTraining(profile) {
    const p = normalizeProfile(profile);
    const split = chooseSplit(p);
    const ex = templateExercises(p.equipment);
    const scheme = repScheme(p.experience, p.goal);
    const days = [];
    const names = dayNames();

    function strengthDay(title, focus, blocks) {
      return {
        kind: "strength",
        title,
        focus,
        durationMinutes: p.sessionMinutes,
        scheme,
        blocks,
      };
    }

    function restDay() {
      return {
        kind: "recovery",
        title: "Recovery",
        focus: "Mobility + easy movement",
        durationMinutes: Math.min(25, p.sessionMinutes),
        blocks: [
          { label: "Walk", items: ["Easy walk 20–30 min"] },
          { label: "Mobility", items: ["Hips + ankles 5 min", "Thoracic + shoulders 5 min"] },
        ],
      };
    }

    const pick = (arr, idx) => arr[idx % arr.length];
    const injuriesNote = p.injuries ? `Constraints: ${p.injuries}` : "";

    let dayTemplates = [];
    if (split === "full_body") {
      dayTemplates = [
        strengthDay("Full Body A", "Squat + Push + Pull", [
          { label: "Main", items: [pick(ex.squat, 0), pick(ex.push, 0), pick(ex.pull, 0)] },
          { label: "Accessory", items: [pick(ex.hinge, 0), pick(ex.shoulders, 1), pick(ex.core, 0)] },
          { label: "Finisher", items: [pick(ex.cardio, 0) + " 8–12 min (easy/moderate)"] },
        ]),
        restDay(),
        strengthDay("Full Body B", "Hinge + Pull + Push", [
          { label: "Main", items: [pick(ex.hinge, 1), pick(ex.pull, 1), pick(ex.push, 1)] },
          { label: "Accessory", items: [pick(ex.squat, 1), pick(ex.shoulders, 0), pick(ex.core, 1)] },
          { label: "Finisher", items: [pick(ex.cardio, 1) + " 8–12 min (easy/moderate)"] },
        ]),
        restDay(),
        strengthDay("Full Body C", "Squat + Upper", [
          { label: "Main", items: [pick(ex.squat, 2), pick(ex.push, 2), pick(ex.pull, 2)] },
          { label: "Accessory", items: [pick(ex.hinge, 2), pick(ex.shoulders, 2), pick(ex.core, 2)] },
          { label: "Finisher", items: [pick(ex.cardio, 2) + " 8–12 min (easy/moderate)"] },
        ]),
        restDay(),
        restDay(),
      ];
    } else if (split === "upper_lower") {
      dayTemplates = [
        strengthDay("Upper 1", "Push + Pull", [
          { label: "Main", items: [pick(ex.push, 0), pick(ex.pull, 0), pick(ex.shoulders, 0)] },
          { label: "Accessory", items: [pick(ex.pull, 1), pick(ex.core, 0)] },
        ]),
        strengthDay("Lower 1", "Squat + Hinge", [
          { label: "Main", items: [pick(ex.squat, 0), pick(ex.hinge, 0)] },
          { label: "Accessory", items: [pick(ex.core, 1), pick(ex.cardio, 0) + " 10 min easy"] },
        ]),
        restDay(),
        strengthDay("Upper 2", "Pull + Push", [
          { label: "Main", items: [pick(ex.pull, 2), pick(ex.push, 1), pick(ex.shoulders, 1)] },
          { label: "Accessory", items: [pick(ex.core, 2)] },
        ]),
        strengthDay("Lower 2", "Hinge + Squat", [
          { label: "Main", items: [pick(ex.hinge, 1), pick(ex.squat, 1)] },
          { label: "Accessory", items: [pick(ex.cardio, 1) + " 10 min easy"] },
        ]),
        restDay(),
        restDay(),
      ];
    } else if (split === "upper_lower_plus") {
      dayTemplates = [
        strengthDay("Upper 1", "Push + Pull", [
          { label: "Main", items: [pick(ex.push, 0), pick(ex.pull, 0), pick(ex.shoulders, 0)] },
          { label: "Accessory", items: [pick(ex.core, 0)] },
        ]),
        strengthDay("Lower 1", "Squat + Hinge", [
          { label: "Main", items: [pick(ex.squat, 0), pick(ex.hinge, 0)] },
          { label: "Accessory", items: [pick(ex.core, 1)] },
        ]),
        restDay(),
        strengthDay("Upper 2", "Pull + Push", [
          { label: "Main", items: [pick(ex.pull, 1), pick(ex.push, 1), pick(ex.shoulders, 1)] },
          { label: "Accessory", items: [pick(ex.core, 2)] },
        ]),
        strengthDay("Lower 2", "Hinge + Squat", [
          { label: "Main", items: [pick(ex.hinge, 1), pick(ex.squat, 1)] },
          { label: "Accessory", items: [pick(ex.cardio, 0) + " 10–15 min easy"] },
        ]),
        strengthDay("Conditioning", "Cardio + Mobility", [
          { label: "Cardio", items: [pick(ex.cardio, 2) + " 25–40 min Zone 2"] },
          { label: "Mobility", items: ["Hips + ankles 6 min", "T-spine + shoulders 6 min"] },
        ]),
        restDay(),
      ];
    } else {
      dayTemplates = [
        strengthDay("Push", "Chest + Shoulders + Triceps", [
          { label: "Main", items: [pick(ex.push, 0), pick(ex.shoulders, 0)] },
          { label: "Accessory", items: [pick(ex.push, 1), pick(ex.core, 0)] },
        ]),
        strengthDay("Pull", "Back + Biceps", [
          { label: "Main", items: [pick(ex.pull, 0), pick(ex.pull, 1)] },
          { label: "Accessory", items: [pick(ex.core, 1)] },
        ]),
        strengthDay("Legs", "Squat + Hinge", [
          { label: "Main", items: [pick(ex.squat, 0), pick(ex.hinge, 0)] },
          { label: "Accessory", items: [pick(ex.squat, 1), pick(ex.core, 2)] },
        ]),
        restDay(),
        strengthDay("Push (light)", "Hypertrophy + Pump", [
          { label: "Main", items: [pick(ex.push, 2), pick(ex.shoulders, 1)] },
          { label: "Accessory", items: [pick(ex.core, 0)] },
        ]),
        strengthDay("Pull (light)", "Hypertrophy + Posture", [
          { label: "Main", items: [pick(ex.pull, 2), pick(ex.shoulders, 2)] },
          { label: "Accessory", items: [pick(ex.core, 1)] },
        ]),
        strengthDay("Legs (light)", "Volume + Cardio", [
          { label: "Main", items: [pick(ex.hinge, 1), pick(ex.squat, 2)] },
          { label: "Accessory", items: [pick(ex.cardio, 1) + " 10–15 min easy"] },
        ]),
      ];
    }

    let strengthCount = 0;
    for (let i = 0; i < 7; i++) {
      const t = dayTemplates[i];
      if (t.kind === "strength" || t.kind === "conditioning") {
        if (strengthCount < p.daysPerWeek) {
          strengthCount++;
          days.push({ ...t, day: names[i], notes: injuriesNote });
        } else {
          days.push({ ...restDay(), day: names[i] });
        }
      } else {
        days.push({ ...t, day: names[i] });
      }
    }

    return {
      split,
      cardio: cardioPrescription(p.goal, p.sessionMinutes),
      progression: [
        "Pick a weight that leaves ~2–3 reps in reserve (RIR).",
        "When you hit the top of the rep range for all sets, add 2–5% load next time.",
        "If energy is low, keep the plan but reduce sets by 1 (minimum effective dose).",
      ],
      days,
    };
  }

  function generatePlan(profile) {
    const p = normalizeProfile(profile);
    const macros = macroTargets(p);
    const training = buildWeeklyTraining(p);
    const cautions = [];
    if (!p.age || !p.heightCm || !p.weightKg) cautions.push("Add age/height/weight for calorie + macro targets.");
    if (p.injuries) cautions.push("Injuries/constraints noted—consider professional guidance if pain is involved.");

    return {
      createdAt: new Date().toISOString(),
      profile: p,
      nutrition: macros
        ? {
            calories: macros.calories,
            proteinG: macros.proteinG,
            carbsG: macros.carbsG,
            fatG: macros.fatG,
            bmr: macros.bmr,
            tdee: macros.tdee,
            guidelines: [
              "Protein: spread across 3–5 meals; include 25–40g per meal.",
              "Fiber: target 25–35g/day (fruits, veg, legumes, whole grains).",
              "Hydration: 30–40 ml/kg/day; more if sweating heavily.",
              "Sleep: target 7–9 hours; keep wake time consistent.",
            ],
          }
        : {
            calories: null,
            proteinG: null,
            carbsG: null,
            fatG: null,
            bmr: null,
            tdee: null,
            guidelines: [
              "Add age/height/weight to get calorie + macro targets.",
              "Prioritize protein + plants + water; keep portions consistent.",
            ],
          },
      training,
      cautions,
      disclaimer:
        "This is a general, educational plan—no medical advice. If you have a medical condition or pain, talk to a qualified professional.",
    };
  }

  return {
    normalizeProfile,
    estimateTdee,
    macroTargets,
    generatePlan,
  };
});
    </script>

    <script>
/* app.js (inlined) */
(function () {
  "use strict";

  const STORAGE_KEY = "pfs-state";
  const STATE_VERSION = 1;

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function nowISODate() {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0, 10);
  }

  function defaultState() {
    return {
      version: STATE_VERSION,
      updatedAt: new Date().toISOString(),
      settings: {
        units: "metric",
      },
      profile: {
        name: "",
        sex: "male",
        age: "",
        heightCm: "",
        weightKg: "",
        goal: "general",
        experience: "beginner",
        daysPerWeek: 3,
        sessionMinutes: 45,
        equipment: "none",
        activityLevel: "light",
        injuries: "",
        preferences: "",
      },
      generated: {
        plan: null,
      },
      logs: {
        workouts: [],
        body: [],
      },
    };
  }

  function safeParse(json) {
    try {
      return JSON.parse(json);
    } catch {
      return null;
    }
  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultState();
    const parsed = safeParse(raw);
    if (!parsed || typeof parsed !== "object") return defaultState();
    return migrateState(parsed);
  }

  function migrateState(s) {
    const state = { ...defaultState(), ...s };
    state.version = STATE_VERSION;
    state.settings = { ...defaultState().settings, ...(s.settings || {}) };
    state.profile = { ...defaultState().profile, ...(s.profile || {}) };
    state.generated = { ...defaultState().generated, ...(s.generated || {}) };
    state.logs = { ...defaultState().logs, ...(s.logs || {}) };
    state.logs.workouts = Array.isArray(state.logs.workouts) ? state.logs.workouts : [];
    state.logs.body = Array.isArray(state.logs.body) ? state.logs.body : [];
    return state;
  }

  function saveState() {
    state.updatedAt = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function toast(msg) {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => t.classList.remove("show"), 2600);
  }

  function setView(name) {
    $$(".view").forEach((v) => v.classList.remove("active"));
    $$(".tab").forEach((t) => t.classList.remove("active"));
    $(`#view-${name}`).classList.add("active");
    $(`#tab-${name}`).classList.add("active");
    render();
  }

  function openModal(title, bodyNodeOrHtml) {
    $("#modalTitle").textContent = title;
    const body = $("#modalBody");
    body.innerHTML = "";
    if (typeof bodyNodeOrHtml === "string") body.innerHTML = bodyNodeOrHtml;
    else body.appendChild(bodyNodeOrHtml);
    $("#modalOverlay").classList.add("open");
  }
  function closeModal() {
    $("#modalOverlay").classList.remove("open");
  }

  function toMetricProfile(profile) {
    return { ...profile };
  }

  function readProfileFromForm() {
    const p = { ...state.profile };
    p.name = $("#p_name").value.trim();
    p.sex = $("#p_sex").value;
    p.age = $("#p_age").value;
    p.heightCm = $("#p_height").value;
    p.weightKg = $("#p_weight").value;
    p.goal = $("#p_goal").value;
    p.experience = $("#p_exp").value;
    p.daysPerWeek = Number($("#p_days").value);
    p.sessionMinutes = Number($("#p_minutes").value);
    p.equipment = $("#p_eq").value;
    p.activityLevel = $("#p_activity").value;
    p.injuries = $("#p_injuries").value.trim();
    p.preferences = $("#p_prefs").value.trim();
    return toMetricProfile(p);
  }

  function fillProfileForm() {
    const p = state.profile;
    $("#p_name").value = p.name || "";
    $("#p_sex").value = p.sex || "male";
    $("#p_age").value = p.age ?? "";
    $("#p_height").value = p.heightCm ?? "";
    $("#p_weight").value = p.weightKg ?? "";
    $("#p_goal").value = p.goal || "general";
    $("#p_exp").value = p.experience || "beginner";
    $("#p_days").value = String(p.daysPerWeek || 3);
    $("#p_minutes").value = String(p.sessionMinutes || 45);
    $("#p_eq").value = p.equipment || "none";
    $("#p_activity").value = p.activityLevel || "light";
    $("#p_injuries").value = p.injuries || "";
    $("#p_prefs").value = p.preferences || "";
  }

  function generatePlan() {
    state.profile = readProfileFromForm();
    const plan = PFSEngine.generatePlan(state.profile);
    state.generated.plan = plan;
    saveState();
    toast("Plan generated.");
    setView("plan");
  }

  function formatNumber(n, suffix = "") {
    if (n == null || n === "") return "—";
    if (!Number.isFinite(+n)) return "—";
    return `${Math.round(+n)}${suffix}`;
  }

  function renderHero() {
    const p = PFSEngine.normalizeProfile(state.profile);
    const name = p.name ? p.name : "Your";
    $("#heroTitle").textContent = `${name} Personalized Fitness System`;

    const hasPlan = !!state.generated.plan;
    const updated = state.updatedAt ? new Date(state.updatedAt) : null;
    $("#pillPlan").innerHTML = `<strong>Plan</strong> ${hasPlan ? "ready" : "not generated"}`;
    $("#pillUpdated").innerHTML = `<strong>Updated</strong> ${updated ? updated.toLocaleString() : "—"}`;
    $("#pillDays").innerHTML = `<strong>${p.daysPerWeek}</strong> days/week`;
    $("#pillGoal").innerHTML = `<strong>Goal</strong> ${p.goal.replace("_", " ")}`;
  }

  function renderPlanView() {
    const plan = state.generated.plan;
    const wrap = $("#planWrap");
    wrap.innerHTML = "";
    if (!plan) {
      wrap.innerHTML =
        `<div class="hint">No plan yet. Go to <strong>Profile</strong>, fill details, then hit <strong>Generate plan</strong>.</div>`;
      return;
    }

    const n = plan.nutrition || {};
    const kpi = document.createElement("div");
    kpi.className = "kpi";
    kpi.innerHTML = `
      <div class="k">
        <div class="l">Calories/day</div>
        <div class="v">${formatNumber(n.calories, " kcal")}</div>
        <div class="s">Based on BMR ${formatNumber(n.bmr)} and TDEE ${formatNumber(n.tdee)}.</div>
      </div>
      <div class="k">
        <div class="l">Macros/day</div>
        <div class="v">${formatNumber(n.proteinG, "g")} P • ${formatNumber(n.carbsG, "g")} C • ${formatNumber(n.fatG, "g")} F</div>
        <div class="s">Use as a target range; consistency beats perfection.</div>
      </div>
    `;

    const nut = document.createElement("div");
    nut.className = "card";
    nut.innerHTML = `
      <div class="head"><div class="h">Nutrition guidelines</div></div>
      <div class="body">
        <div class="list" id="nutList"></div>
        <div class="hint" style="margin-top:10px;">${plan.disclaimer}</div>
      </div>
    `;

    const nutList = nut.querySelector("#nutList");
    (n.guidelines || []).forEach((g) => {
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `<div class="meta"><div class="t">${escapeHtml(g)}</div></div>`;
      nutList.appendChild(it);
    });

    const train = document.createElement("div");
    train.className = "card";
    train.innerHTML = `
      <div class="head"><div class="h">Weekly training plan</div><div class="hint" style="margin:0;">Split: <strong>${escapeHtml(plan.training.split.replaceAll("_", " "))}</strong></div></div>
      <div class="body">
        <div class="hint"><strong>Cardio:</strong> ${escapeHtml(plan.training.cardio)}</div>
        <div class="hint" style="margin-top:8px;"><strong>Progression:</strong> ${escapeHtml((plan.training.progression || []).join(" "))}</div>
        <hr style="border:0;border-top:1px solid rgba(255,255,255,0.10);margin:14px 0;">
        <div class="list" id="dayList"></div>
      </div>
    `;
    const dayList = train.querySelector("#dayList");
    (plan.training.days || []).forEach((d) => {
      const blocks = (d.blocks || []).map((b) => {
        const items = (b.items || []).map((x) => `<li>${escapeHtml(x)}</li>`).join("");
        return `<div style="margin-top:8px;"><div class="hint" style="margin:0;"><strong>${escapeHtml(b.label)}</strong></div><ul style="margin:6px 0 0 18px;color:rgba(255,255,255,0.80);">${items}</ul></div>`;
      }).join("");
      const scheme = d.scheme ? `${d.scheme.sets} sets • ${d.scheme.reps} reps • rest ${d.scheme.rest}` : "";
      const note = d.notes ? `<div class="hint"><span class="warn">Note:</span> ${escapeHtml(d.notes)}</div>` : "";
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div class="meta">
          <div class="t">${escapeHtml(d.day)} — ${escapeHtml(d.title)}</div>
          <div class="d">${escapeHtml(d.focus || "")}${scheme ? ` • ${escapeHtml(scheme)}` : ""}</div>
          ${note}
          ${blocks}
        </div>
      `;
      dayList.appendChild(it);
    });

    if (plan.cautions && plan.cautions.length) {
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `
        <div class="head"><div class="h">Cautions</div></div>
        <div class="body">
          <div class="list" id="cautionList"></div>
        </div>
      `;
      const list = c.querySelector("#cautionList");
      plan.cautions.forEach((x) => {
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `<div class="meta"><div class="t"><span class="warn">Heads up:</span> ${escapeHtml(x)}</div></div>`;
        list.appendChild(it);
      });
      wrap.appendChild(kpi);
      wrap.appendChild(c);
      wrap.appendChild(train);
      wrap.appendChild(nut);
    } else {
      wrap.appendChild(kpi);
      wrap.appendChild(train);
      wrap.appendChild(nut);
    }
  }

  function addWorkoutFromForm() {
    const date = $("#w_date").value || nowISODate();
    const type = $("#w_type").value;
    const minutes = Number($("#w_minutes").value || 0);
    const rpe = Number($("#w_rpe").value || 0);
    const notes = $("#w_notes").value.trim();
    const title = $("#w_title").value.trim() || (type === "strength" ? "Strength session" : type === "cardio" ? "Cardio session" : "Mobility session");

    if (!minutes || minutes < 5) {
      toast("Add workout duration (min).");
      return;
    }

    state.logs.workouts.unshift({
      id: String(Date.now()),
      date,
      title,
      type,
      minutes,
      rpe: rpe ? rpe : null,
      notes,
      createdAt: new Date().toISOString(),
    });
    $("#w_title").value = "";
    $("#w_minutes").value = "";
    $("#w_rpe").value = "";
    $("#w_notes").value = "";
    saveState();
    toast("Workout logged.");
    renderLogs();
    renderCharts();
  }

  function addBodyEntryFromForm() {
    const date = $("#b_date").value || nowISODate();
    const weightKg = Number($("#b_weight").value || 0);
    const waistCm = Number($("#b_waist").value || 0);
    const notes = $("#b_notes").value.trim();

    if (!weightKg || weightKg < 30) {
      toast("Add body weight (kg).");
      return;
    }

    state.logs.body.unshift({
      id: String(Date.now()),
      date,
      weightKg,
      waistCm: waistCm ? waistCm : null,
      notes,
      createdAt: new Date().toISOString(),
    });
    $("#b_weight").value = "";
    $("#b_waist").value = "";
    $("#b_notes").value = "";
    saveState();
    toast("Body metrics saved.");
    renderLogs();
    renderCharts();
  }

  function deleteLog(kind, id) {
    if (kind === "workout") state.logs.workouts = state.logs.workouts.filter((x) => x.id !== id);
    if (kind === "body") state.logs.body = state.logs.body.filter((x) => x.id !== id);
    saveState();
    toast("Deleted.");
    renderLogs();
    renderCharts();
  }

  function renderLogs() {
    const w = $("#workoutList");
    const b = $("#bodyList");
    w.innerHTML = "";
    b.innerHTML = "";

    const workouts = state.logs.workouts.slice(0, 50);
    if (!workouts.length) {
      w.innerHTML = `<div class="hint">No workouts logged yet.</div>`;
    } else {
      workouts.forEach((x) => {
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `
          <div class="meta">
            <div class="t">${escapeHtml(x.title)}</div>
            <div class="d">${escapeHtml(x.date)} • ${escapeHtml(x.type)} • ${escapeHtml(String(x.minutes))} min${x.rpe ? ` • RPE ${escapeHtml(String(x.rpe))}` : ""}</div>
            ${x.notes ? `<div class="n">${escapeHtml(x.notes)}</div>` : ""}
          </div>
          <div class="right">
            <button class="btn small danger" data-del="workout:${escapeAttr(x.id)}">Delete</button>
          </div>
        `;
        w.appendChild(it);
      });
    }

    const body = state.logs.body.slice(0, 50);
    if (!body.length) {
      b.innerHTML = `<div class="hint">No body metrics yet (weight/waist).</div>`;
    } else {
      body.forEach((x) => {
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `
          <div class="meta">
            <div class="t">${escapeHtml(x.date)}</div>
            <div class="d">${escapeHtml(String(Math.round(x.weightKg)))} kg${x.waistCm ? ` • ${escapeHtml(String(Math.round(x.waistCm)))} cm waist` : ""}</div>
            ${x.notes ? `<div class="n">${escapeHtml(x.notes)}</div>` : ""}
          </div>
          <div class="right">
            <button class="btn small danger" data-del="body:${escapeAttr(x.id)}">Delete</button>
          </div>
        `;
        b.appendChild(it);
      });
    }
  }

  function renderCharts() {
    drawWeightChart($("#weightChart"), state.logs.body);
    drawWorkoutsChart($("#workoutChart"), state.logs.workouts);
  }

  function drawAxes(ctx, w, h) {
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(36, 12);
    ctx.lineTo(36, h - 26);
    ctx.lineTo(w - 12, h - 26);
    ctx.stroke();
  }

  function drawWeightChart(canvas, entries) {
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = (canvas.width = canvas.clientWidth * devicePixelRatio);
    const h = (canvas.height = canvas.clientHeight * devicePixelRatio);
    ctx.clearRect(0, 0, w, h);
    drawAxes(ctx, w, h);

    const pts = (entries || [])
      .map((e) => ({ date: e.date, y: Number(e.weightKg) }))
      .filter((p) => Number.isFinite(p.y))
      .sort((a, b) => a.date.localeCompare(b.date));

    ctx.fillStyle = "rgba(255,255,255,0.70)";
    ctx.font = `${12 * devicePixelRatio}px ui-sans-serif, system-ui`;
    ctx.fillText("Weight (kg)", 12 * devicePixelRatio, 16 * devicePixelRatio);

    if (pts.length < 2) {
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.fillText("Log at least 2 entries to see a trend.", 12 * devicePixelRatio, 36 * devicePixelRatio);
      return;
    }

    const minY = Math.min(...pts.map((p) => p.y));
    const maxY = Math.max(...pts.map((p) => p.y));
    const pad = Math.max(1, (maxY - minY) * 0.12);
    const y0 = minY - pad;
    const y1 = maxY + pad;

    const xLeft = 36 * devicePixelRatio;
    const xRight = w - 12 * devicePixelRatio;
    const yTop = 12 * devicePixelRatio;
    const yBottom = h - 26 * devicePixelRatio;

    const xFor = (i) => xLeft + (i / (pts.length - 1)) * (xRight - xLeft);
    const yFor = (val) => yBottom - ((val - y0) / (y1 - y0)) * (yBottom - yTop);

    ctx.strokeStyle = "rgba(57,217,138,0.85)";
    ctx.lineWidth = 2 * devicePixelRatio;
    ctx.beginPath();
    pts.forEach((p, i) => {
      const x = xFor(i);
      const y = yFor(p.y);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    ctx.fillStyle = "rgba(57,217,138,0.95)";
    pts.forEach((p, i) => {
      const x = xFor(i);
      const y = yFor(p.y);
      ctx.beginPath();
      ctx.arc(x, y, 3.2 * devicePixelRatio, 0, Math.PI * 2);
      ctx.fill();
    });

    ctx.fillStyle = "rgba(255,255,255,0.60)";
    ctx.fillText(String(Math.round(maxY)), 6 * devicePixelRatio, yFor(maxY) + 4 * devicePixelRatio);
    ctx.fillText(String(Math.round(minY)), 6 * devicePixelRatio, yFor(minY) + 4 * devicePixelRatio);
  }

  function weekKey(isoDate) {
    const d = new Date(isoDate + "T00:00:00Z");
    if (Number.isNaN(d.getTime())) return null;
    const day = (d.getUTCDay() + 6) % 7;
    d.setUTCDate(d.getUTCDate() - day + 3);
    const firstThursday = new Date(Date.UTC(d.getUTCFullYear(), 0, 4));
    const firstDay = (firstThursday.getUTCDay() + 6) % 7;
    firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDay + 3);
    const week = 1 + Math.round((d - firstThursday) / (7 * 24 * 3600 * 1000));
    return `${d.getUTCFullYear()}-W${String(week).padStart(2, "0")}`;
  }

  function drawWorkoutsChart(canvas, workouts) {
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = (canvas.width = canvas.clientWidth * devicePixelRatio);
    const h = (canvas.height = canvas.clientHeight * devicePixelRatio);
    ctx.clearRect(0, 0, w, h);
    drawAxes(ctx, w, h);

    ctx.fillStyle = "rgba(255,255,255,0.70)";
    ctx.font = `${12 * devicePixelRatio}px ui-sans-serif, system-ui`;
    ctx.fillText("Workouts/week", 12 * devicePixelRatio, 16 * devicePixelRatio);

    const map = new Map();
    (workouts || []).forEach((x) => {
      const k = weekKey(x.date);
      if (!k) return;
      map.set(k, (map.get(k) || 0) + 1);
    });
    const keys = Array.from(map.keys()).sort();
    if (keys.length < 2) {
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.fillText("Log workouts across at least 2 weeks to see a trend.", 12 * devicePixelRatio, 36 * devicePixelRatio);
      return;
    }

    const vals = keys.map((k) => map.get(k));
    const maxV = Math.max(...vals, 1);
    const xLeft = 36 * devicePixelRatio;
    const xRight = w - 12 * devicePixelRatio;
    const yTop = 12 * devicePixelRatio;
    const yBottom = h - 26 * devicePixelRatio;
    const xFor = (i) => xLeft + (i / (keys.length - 1)) * (xRight - xLeft);
    const yFor = (val) => yBottom - (val / maxV) * (yBottom - yTop);

    ctx.strokeStyle = "rgba(88,166,255,0.85)";
    ctx.lineWidth = 2 * devicePixelRatio;
    ctx.beginPath();
    vals.forEach((v, i) => {
      const x = xFor(i);
      const y = yFor(v);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    ctx.fillStyle = "rgba(88,166,255,0.95)";
    vals.forEach((v, i) => {
      const x = xFor(i);
      const y = yFor(v);
      ctx.beginPath();
      ctx.arc(x, y, 3.2 * devicePixelRatio, 0, Math.PI * 2);
      ctx.fill();
    });

    ctx.fillStyle = "rgba(255,255,255,0.60)";
    ctx.fillText(String(maxV), 6 * devicePixelRatio, yFor(maxV) + 4 * devicePixelRatio);
    ctx.fillText("0", 12 * devicePixelRatio, yFor(0) + 4 * devicePixelRatio);
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
  }
  function escapeAttr(s) {
    return escapeHtml(s).replaceAll("'", "&#39;");
  }

  function openExport() {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pfs-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast("Exported backup.");
  }

  function openImport() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json,.json";
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const parsed = safeParse(reader.result);
        if (!parsed) {
          toast("Invalid JSON file.");
          return;
        }
        state = migrateState(parsed);
        saveState();
        fillProfileForm();
        toast("Imported.");
        render();
      };
      reader.readAsText(file);
    };
    input.click();
  }

  function resetAll() {
    openModal(
      "Reset everything?",
      `<div class="hint">This will delete your profile, plan, and logs from this browser.</div>
       <div class="hint"><span class="dangerText">This cannot be undone.</span> Export a backup first if you want to keep your data.</div>`
    );
    $("#modalConfirm").onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      saveState();
      fillProfileForm();
      closeModal();
      toast("Reset complete.");
      setView("profile");
    };
  }

  function renderProfileSummary() {
    const p = PFSEngine.normalizeProfile(state.profile);
    const est = PFSEngine.estimateTdee(p);
    $("#profileSummary").innerHTML = `
      <div class="k">
        <div class="l">Estimated BMR</div>
        <div class="v">${est ? formatNumber(est.bmr, " kcal") : "—"}</div>
        <div class="s">Resting energy estimate (Mifflin-St Jeor).</div>
      </div>
      <div class="k">
        <div class="l">Estimated TDEE</div>
        <div class="v">${est ? formatNumber(est.tdee, " kcal") : "—"}</div>
        <div class="s">Daily energy with activity level.</div>
      </div>
    `;
  }

  function render() {
    renderHero();
    const active = $(".view.active")?.id || "";
    if (active === "view-profile") renderProfileSummary();
    if (active === "view-plan") renderPlanView();
    if (active === "view-log") renderLogs();
    if (active === "view-progress") renderCharts();
  }

  function wireEvents() {
    ["profile", "plan", "log", "progress", "settings"].forEach((name) => {
      $(`#tab-${name}`).addEventListener("click", () => setView(name));
    });

    $("#btnGenerate").addEventListener("click", generatePlan);
    $("#btnSaveProfile").addEventListener("click", () => {
      state.profile = readProfileFromForm();
      saveState();
      toast("Profile saved.");
      renderProfileSummary();
    });
    $$("#view-profile input, #view-profile select, #view-profile textarea").forEach((el) => {
      el.addEventListener("change", () => {
        state.profile = readProfileFromForm();
        saveState();
        renderProfileSummary();
      });
    });

    $("#w_date").value = nowISODate();
    $("#b_date").value = nowISODate();
    $("#btnAddWorkout").addEventListener("click", addWorkoutFromForm);
    $("#btnAddBody").addEventListener("click", addBodyEntryFromForm);
    $("#view-log").addEventListener("click", (e) => {
      const btn = e.target.closest?.("[data-del]");
      if (!btn) return;
      const [kind, id] = btn.getAttribute("data-del").split(":");
      deleteLog(kind, id);
    });

    window.addEventListener("resize", () => {
      if ($("#view-progress").classList.contains("active")) renderCharts();
    });

    $("#btnExport").addEventListener("click", openExport);
    $("#btnImport").addEventListener("click", openImport);
    $("#btnReset").addEventListener("click", resetAll);

    $("#modalCancel").addEventListener("click", () => {
      closeModal();
      $("#modalConfirm").onclick = null;
    });
    $("#modalConfirm").addEventListener("click", () => {
      if (typeof $("#modalConfirm").onclick === "function") $("#modalConfirm").onclick();
    });
  }

  let state = loadState();

  window.addEventListener("DOMContentLoaded", () => {
    fillProfileForm();
    wireEvents();
    setView("profile");
    render();

    const btn = document.getElementById("btnGenerate2");
    if (btn) btn.addEventListener("click", () => document.getElementById("btnGenerate")?.click());
  });
})();
    </script>
  </body>
</html>

